---
title: "Full Lexicon Analysis"
author: "Matt Mackenzie"
date: "11/22/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(tidytext)
library(broom)

library(ggthemes)
theme_set(theme_gdocs())

no_legend <- theme(legend.position = "none")
legend_top <- theme(legend.position = "top", 
                    legend.direction = "horizontal")
```

```{r}
data <- read_csv("data/word_frequencies_grouped.csv")
library(viridis)

data %>%
  filter(n_synnouns == 0) %>%
  select(society, country, year, word, freq) %>%
  group_by(word) %>%
  filter(n_distinct(society) == 1) %>%
  group_by(society, country, year) %>%
  top_n(5, freq) %>%
  write.csv("top_5_words_by_year.csv", row.names = FALSE)

summary <- data %>%
  filter(n_synnouns == 0) %>%
  select(society, country, year, word, freq) %>%
  group_by(word) %>%
  filter(n_distinct(society) == 1) %>%
  group_by(society, country, year) %>%
  top_n(5, freq) %>%
  group_by(country, year) %>%
  mutate(norm_freq = scale(freq)) %>%
  ungroup()

summary %>%
  group_by(society) %>%
  summarise(num_words = n_distinct(word)) %>%
  ggplot(aes(society, num_words, fill = society)) + 
  geom_col() + 
  no_legend + 
  labs(title = "How many unique words are used in each society?", 
       subtitle = "Top 5 most frequent words (removing most nouns, and words that appear in \nboth society classes) in each country/year.", 
       x = "Society", 
       y = "Number of Unique Words")
  

summary %>%
  filter(society == "Peaceful") %>%
  ggplot(aes(year, fct_reorder(word, norm_freq), fill = norm_freq)) + 
  geom_tile() + 
  facet_wrap(~ country, scales = "free_y") + 
  scale_fill_viridis() + 
  scale_x_continuous(breaks = scales::pretty_breaks()) + 
  labs(title = "How are the most frequent words changing in peaceful country by year?", 
       subtitle = "Top 5 most frequent words (removing most nouns, and words that appear in both society classes) in each country/year.", 
       x = "Year", 
       y = "", 
       fill = "Norm. WF", 
       caption = "Norm. WF = Normalized Word Frequency. Normalization happens at the country/year level.") + 
  theme(axis.text = element_text(size = 10))

summary %>%
  filter(society == "Nonpeaceful") %>%
  ggplot(aes(year, fct_reorder(word, norm_freq), fill = norm_freq)) + 
  geom_tile() + 
  facet_wrap(~ country, scales = "free_y") + 
  scale_fill_viridis() + 
  scale_x_continuous(breaks = scales::pretty_breaks()) + 
  labs(title = "How are the most frequent words changing in nonpeaceful country by year?", 
       subtitle = "Top 5 most frequent words (removing most nouns, and words that appear in both society classes) in each country/year.", 
       x = "Year", 
       y = "", 
       fill = "Norm. WF", 
       caption = "Norm. WF = Normalized Word Frequency. Normalization happens at the country/year level.") + 
  theme(axis.text = element_text(size = 10))
```

```{r}
library(countrycode)


countries.peaceful <- c("New Zealand", "Canada", "Ireland", "Australia", "United Kingdom", "Singapore")
countries.non_peaceful <- c("Kenya", "Zimbabwe", "Bangladesh", "Pakistan", "Nigeria", "Tanzania")

get_society_cat <- Vectorize(function(country) {
  if (country %in% countries.peaceful) {
    return("Peaceful")
  } else if (country %in% countries.non_peaceful) {
    return("Non-Peaceful")
  } else {
    return("Other")
  }
})

tf <- read_csv("data/lexicon_tf_by_country_year.csv") %>%
  mutate(country_name = countrycode(country, "iso2c", "country.name"),
         society = get_society_cat(country_name))

top_lexicon_words_by_society <- tf %>%
  group_by(society, lexicon, version, term) %>%
  summarise(n = sum(n)) %>%
  ungroup() %>%
  group_by(society) %>%
  top_n(100, n) %>%
  arrange(society, desc(n))

top_lexicon_words_by_society %>%
  write.csv("top_words_by_society_all_lexicons.csv", row.names = FALSE)

top_lexicon_words_by_society %>%
  ungroup() %>%
  count(society, lexicon, version) %>%
  mutate(name = glue::glue("{ lexicon } - { version }")) %>%
  mutate(society = factor(society, levels = c("Peaceful", "Other", "Non-Peaceful"))) %>%
  mutate(name = reorder_within(name, n, society)) %>%
  ggplot(aes(name, n, fill = society)) + 
  geom_col() + 
  facet_wrap(~society, scales = "free_y") + 
  scale_x_reordered() + 
  scale_fill_manual(values = c("#6db7f7", "#36CB8A", "#FF5A59")) + 
  coord_flip() + 
  theme(legend.position = "none") + 
  labs(title = "What is the prominent lexicon in each society?",
       subtitle = "Top 100 most frequent words from each society. Sample of 1 million articles.",
       x = "Lexicon", 
       y = "Number of Terms")
# 
# tf %>%
#   group_by(lexicon, version, term) %>%
#   summarise(n = sum(n)) %>%
#   top_n(5) %>% 
#   arrange(version, lexicon, desc(n)) %>% View()
```

```{r}
tf %>%
  filter(version == "old", lexicon != "resilience") %>%
  ungroup() %>%
  group_by(society, country, lexicon) %>%
  summarise(n = sum(n)) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  select(-n) %>%
  spread(lexicon, pct) %>%
  mutate(score = peace - conflict, 
         norm_score = scale(score)) %>% 
  mutate(society = factor(society, levels = c("Peaceful", "Other", "Non-Peaceful"))) %>%
  filter(!is.na(society)) %>%
  ggplot(aes(fct_reorder(country, norm_score), norm_score, fill = society)) + 
  geom_col() + 
  facet_wrap(~ society, nrow = 1, scales = "free_x") + 
  scale_fill_manual(values = c("#6db7f7", "#36CB8A", "#FF5A59")) + 
  theme(legend.position = "top", 
        legend.direction = "horizontal") + 
  labs(title = "Peaceful Score by Country. Original lexicon only.",
       subtitle = "Sample of 1 million articles.",
       x = "", 
       y = "Peaceful Score")

tf %>%
  filter(version == "new", lexicon != "resilience") %>%
  ungroup() %>%
  group_by(society, country, lexicon) %>%
  summarise(n = sum(n)) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  select(-n) %>%
  spread(lexicon, pct) %>%
  mutate(score = peace - conflict, 
         norm_score = scale(score)) %>% 
  mutate(society = factor(society, levels = c("Peaceful", "Other", "Non-Peaceful"))) %>%
  filter(!is.na(society)) %>%
  ggplot(aes(fct_reorder(country, norm_score), norm_score, fill = society)) + 
  geom_col() + 
  facet_wrap(~ society, nrow = 1, scales = "free_x") + 
  scale_fill_manual(values = c("#6db7f7", "#36CB8A", "#FF5A59")) + 
  theme(legend.position = "top", 
        legend.direction = "horizontal") + 
  labs(title = "Peaceful Score by Country. New lexicon only.",
       subtitle = "Sample of 1 million articles.",
       x = "", 
       y = "Peaceful Score")

tf %>%
  filter(lexicon != "resilience") %>%
  ungroup() %>%
  group_by(society, country, lexicon) %>%
  summarise(n = sum(n)) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  select(-n) %>%
  spread(lexicon, pct) %>%
  mutate(score = peace - conflict, 
         norm_score = scale(score)) %>% 
  mutate(society = factor(society, levels = c("Peaceful", "Other", "Non-Peaceful"))) %>%
  filter(!is.na(society)) %>%
  ggplot(aes(fct_reorder(country, norm_score), norm_score, fill = society)) + 
  geom_col() + 
  facet_wrap(~ society, nrow = 1, scales = "free_x") + 
  scale_fill_manual(values = c("#6db7f7", "#36CB8A", "#FF5A59")) + 
  theme(legend.position = "top", 
        legend.direction = "horizontal") + 
  labs(title = "Peaceful Score by Country. Both Lexicons Combined",
       subtitle = "Sample of 1 million articles.",
       x = "", 
       y = "Peaceful Score")

tf %>%
  filter(lexicon != "resilience") %>%
  ungroup() %>%
  group_by(society, country, lexicon) %>%
  summarise(n = sum(n)) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  select(-n) %>%
  spread(lexicon, pct) %>%
  mutate(score = peace - conflict, 
         norm_score = scale(score)) %>% 
  mutate(society = factor(society, levels = c("Peaceful", "Other", "Non-Peaceful"))) %>%
  filter(!is.na(society)) %>%
  aov(norm_score ~ society, data = .) %>% 
  summary()
```


```{r}
library(widyr)
library(igraph)
library(ggraph)

word_cors <- read_csv("data/1m_sample_term_corr.csv")

word_cors %>%
  mutate(abs_corr = abs(corr)) %>%
  filter(abs_corr > 0.2) %>%
  arrange(desc(abs_corr)) %>%
  head(400) %>%
  graph_from_data_frame() %>%
  ggraph(layout = "fr") +
  geom_edge_link() +
  geom_node_point() + 
  # geom_node_point(aes(size = num_articles * 1.1)) +
  # geom_node_point(aes(size = num_articles, color = society)) +
  geom_node_text(aes(label = name), repel = TRUE)
  # scale_color_manual(values = c("#36CB8A", "#FF5A59", "#6db7f7")) + 
  theme_gdocs() + 
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank())
```

```{r}
library(tidymodels)

tf
```

